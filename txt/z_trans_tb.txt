z_trans_tb01:--z_trans_tb01
	declare @t_bdate nvarchar(10) = case when '#non'=[1] then '' else [1] end
	declare @t_edate nvarchar(10) = case when '#non'=[2] then char(255) else [2] end
	declare @t_btrandate nvarchar(10) = case when '#non'=[3] then '' else [3] end
	declare @t_etrandate nvarchar(10) = case when '#non'=[4] then char(255) else [4] end
	declare @t_bcustno nvarchar(20) = case when '#non'=[5] then '' else [5] end
	declare @t_ecustno nvarchar(20) = case when '#non'=[6] then char(255) else [6] end
	declare @t_bdriverno nvarchar(20) = case when '#non'=[7] then '' else [7] end
	declare @t_edriverno nvarchar(20) = case when '#non'=[8] then char(255) else [8] end
	declare @t_carno nvarchar(20) = case when '#non'=[9] then '' else [9] end
	declare @t_po nvarchar(max) = case when '#non'=[10] then '' else [10] end
	declare @t_straddrno nvarchar(20) = case when '#non'=[11] then '' else [11] end
	declare @t_endaddrno nvarchar(20) = case when '#non'=[12] then '' else [12] end
	declare @t_calctype nvarchar(max) = case when '#non'=[13] then '' else [13] end
	
	
	--------------------------------------------------------------------------------------------	
	declare @string nvarchar(max)
	declare @n int
	declare @calctype table(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @calctype select @string
			end
			break
		end
		insert into @calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	--------------------------------------------------------------------------------------------	
	declare @tmp table(
		pno nvarchar(10),
		gno nvarchar(10),
		accy nvarchar(10),
		noa nvarchar(20),
		noq nvarchar(10),
		datea nvarchar(10),
		trandate nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(30),
		custno nvarchar(20),
		cust nvarchar(40),
		nick nvarchar(20),
		cardealno nvarchar(20),
		cardeal nvarchar(20),
		straddrno nvarchar(20),
		straddr nvarchar(40),
		endaddrno nvarchar(40),
		endaddr nvarchar(40),
		fill nvarchar(20),
		
		inmount float,
		pton float,
		mount float,
		unit nvarchar(20),
		price float,
		total float,
		
		outmount float,
		pton2 float,
		mount2 float,
		unit2 nvarchar(20),
		price2 float,
		price3 float,
		discount float,
		total2 float,
		
		caseno nvarchar(30),
		caseno2 nvarchar(30),
		
		pstatus int
	)
	
	insert into @tmp(pno,gno,accy,noa,noq,datea,trandate
		,carno,driverno,driver,custno,cust,nick,cardealno,cardeal,straddrno,straddr,endaddrno,endaddr
		,inmount,pton,mount,unit,price,total
		,outmount,pton2,mount2,unit2,price2,price3,discount,total2,caseno,caseno2)
	select '1','1',a.accy,a.noa,a.noq,a.datea,a.trandate
		,a.carno,a.driverno,a.driver,a.custno,a.custno,a.nick,a.cardeal,a.cardeal,a.straddrno,a.straddr,a.endaddrno,a.endaddr
		,a.inmount,a.pton,a.mount,a.unit,a.price,a.total
		,a.inmount,a.pton2,a.mount2,a.unit2
		,a.price2,a.price3,a.discount,a.total2
		,a.caseno,a.caseno2
	--	,case when d.noa is null and e.noa is null then 1 when d.noa is null then 2 when e.noa is null then 3 else 0 end
	from view_trans a
	left join addr b on a.straddrno = b.straddrno and a.endaddrno=b.endaddrno and a.uccno=b.productno
	left join calctypes c on a.calctype = c.noa+c.noq
--	outer apply (select top 1 * from addrs where noa=b.noa and datea<=a.trandate and custunit=a.unit order by datea desc) d
--	outer apply (select top 1 * from addrs where noa=b.noa and datea<=a.trandate and ((c.isoutside=0 and driverunit=a.unit2) or (c.isoutside=1 and driverunit2=a.unit2)) order by datea desc) e
	right join @calctype f on a.calctype=f.noa
	where a.trandate between @t_btrandate and @t_etrandate
	and a.datea between @t_bdate and @t_edate
	and a.custno between @t_bcustno and @t_ecustno
	and a.driverno between @t_bdriverno and @t_edriverno
	and (len(@t_carno)=0 or a.carno=@t_carno)
	and (len(@t_po)=0 or a.po=@t_po)
	and (len(@t_straddrno)=0 or a.straddrno=@t_straddrno)
	and (len(@t_endaddrno)=0 or a.endaddrno=@t_endaddrno)
	order by a.trandate,a.custno
	
	update @tmp set total = ROUND(isnull(mount,0)*isnull(price,0),0),total2 = ROUND(isnull(mount2,0)*isnull(price2,0),0)
	
	insert into @tmp(pno,gno,total,total2)
	select 'z','2',SUM(total),SUM(total2) from @tmp where gno='1'
	
	select * 
	,datea a01
	,trandate a02
	,carno a03
	,driver a04
	,cardeal a05
	,cust a06
	,straddr a07
	,endaddr a08
	,fill a09
	,caseno a10
	,caseno2 a11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) a12
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) a13
	from @tmp
	order by pno;
--------------------------------------------------------------------------------------------------------------------*
z_trans_tb02:--z_trans_tb02  查詢區間不可超過三個月--- ref:z_tran01
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_carno nvarchar(20)
	declare @t_carkind  nvarchar(max)
	declare @t_rate nvarchar(10)
	declare @t_sort01 nvarchar(max)
	declare @t_filter nvarchar(max)
	declare @t_option nvarchar(max)
	
	set @t_accy = '[19]'
	set @t_btrandate = case when '#non'=[3] then '' else [3] end
	set @t_etrandate = case when '#non'=[4] then CHAR(255) else [4] end
	set @t_carno = case when '#non'=[9] then '' else [9] end
	set @t_carkind  = case when '#non'=[14] then '' else [14] end
	set @t_rate  = case when '#non'=[15] then '' else [15] end
	set @t_sort01  = case when '#non'=[16] then '' else [16] end
	set @t_filter  = case when '#non'=[17] then '' else [17] end
	set @t_option  = case when '#non'=[18] then '' else [18] end
	----------------------------------------------------------------------------------------------
	set @t_btrandate = case when len(@t_btrandate)=0 then @t_accy+'/01/01' else @t_btrandate end
	set @t_etrandate = case when @t_etrandate=CHAR(255) then @t_accy+'/12/31' else @t_etrandate end
	----------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end

	----------------------------------------------------------------------------------------------
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	----------------------------------------------------------------------------------------------
	
	declare @t_date nvarchar(10)
	declare @t_date1 nvarchar(10)
	declare @t_date2 nvarchar(10)

	set @t_date1 = convert(nvarchar(4),convert(int,LEFT(@t_btrandate,3))+1911)+'-'+SUBSTRING(@t_btrandate,5,2)+'-'+RIGHT(@t_btrandate,2)
	set @t_date2 = convert(nvarchar(4),convert(int,LEFT(@t_etrandate,3))+1911)+'-'+SUBSTRING(@t_etrandate,5,2)+'-'+RIGHT(@t_etrandate,2)
	set @t_date=@t_date1

	if(isdate(@t_date1)=0 or isdate(@t_date2)=0)
	begin
		print '日期錯誤'
		return	
	end
	--if(DATEDIFF(MM,@t_date1,@t_date2)>2)
	--begin
	--	print '查詢區間不可超過三個月'
	--	return	
	--end
	IF OBJECT_ID('tempdb..#listDate')is not null
	BEGIN
		set @cmd = 'drop table #listDate'
		EXECUTE sp_executesql @cmd
	END
	create table #listDate(
		[date] nvarchar(20)
	)

	while (@t_date between @t_date1 and @t_date2)
	begin
		insert into #listDate select right('00'+convert(nvarchar(3),convert(int,YEAR(@t_date))-1911),3)+'/'+right('0'+convert(nvarchar(2),convert(int,MONTH(@t_date))),2)+'/'+right('0'+convert(nvarchar(2),convert(int,DAY(@t_date))),2)
		set @t_date= convert(date,DATEADD(DD,1,@t_date),111)
	end
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#listCarno')is not null
	BEGIN
		set @cmd = 'drop table #listCarno'
		EXECUTE sp_executesql @cmd
	END
	create table #listCarno(
		carno nvarchar(20),	
		carkindno nvarchar(20),
		carkind nvarchar(20)																																				
	)
	set @cmd=
	" select  a.carno,isnull(c.noa,''),isnull(c.kind,'') "+ 
	" from  view_trans"+@t_accy+" a  "+
	" left join car2 b on a.carno=b.carno"+
	" left join carKind c on b.carkindno=c.noa"+
	" left join calctypes d on d.noa+d.noq=a.calctype"+
	" left join #carkind e on e.noa=c.noa"+ 
	" where isnull(d.isoutside,0)=0"+
	" and (len(@t_carno)=0 or @t_carno=a.carno)"+
	" and (e.noa is not null)"+
	" and (LEFT(a.trandate,6)  between LEFT(@t_btrandate,6)  and  LEFT(@t_etrandate,6)) "+ 
	" group  by a.carno,isnull(c.noa,''),isnull(c.kind,'') "
	
	insert into #listCarno
	execute  sp_executesql @cmd,N'@t_carno nvarchar(20),@t_btrandate  nvarchar(10),@t_etrandate  nvarchar(10)',@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_carno=@t_carno
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran01')is not null
	BEGIN
		set @cmd = 'drop table #z_tran01'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran01 (
		n float,
		gno nvarchar(3),
		carno nvarchar(20),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		trandate nvarchar(10),
		miles float,
		tranmoney float,
		drivermoney float,
		oilmount float,
		oilmoney float,
		tolls float,
		ticket float,
		reserve float,
		profit  float,
		memo nvarchar(max),
		rate1 float,
		zdriver nvarchar(20),
		zaddr nvarchar(40),
		zmoney nvarchar(20),
		zmiles nvarchar(20),
		
		ystation nvarchar(20),
		ymount nvarchar(20),
		yprice nvarchar(20),
		ymiles nvarchar(20),
		ymoney nvarchar(20),
		ybmiles nvarchar(20),
		yemiles nvarchar(20)
	)
	CREATE INDEX noa ON #z_tran01 (carno,trandate)
	
	declare cursor_table cursor for
	select carno,carkindno,carkind,[date] from #listCarno,#listDate
	open cursor_table
	fetch next from cursor_table
	into @carno,@carkindno,@carkind,@datea
	while(@@FETCH_STATUS <> -1)
	begin
		insert into #z_tran01(n,gno,carno,carkindno,carkind,trandate,rate1)values(-1,'1',@carno,@carkindno,@carkind,@datea,0)
		fetch next from cursor_table
		into @carno,@carkindno,@carkind,@datea
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	declare @trandate nvarchar(10)
	declare @memo nvarchar(max)
	--出車單
	declare @tmp table(
		carno nvarchar(20),
		trandate nvarchar(20),
		miles float,
		tranmoney float,
		drivermoney float,
		reserve float
	)
	set @cmd  =
	" select a.carno,a.trandate"+
	" ,sum(ISNULL(miles,0))"+
	" ,sum(round(a.price*a.mount,0))"+
	" ,sum(round(a.price2*a.mount2*a.discount,0))"+
	" ,sum(isnull(a.reserve,0))"+
	" from view_trans"+@t_accy+" a"+
	" left join car2 b on a.carno=b.carno"+
	" left join #carkind c on b.carkindno=c.noa"+
	" left  join  calctypes d on d.noa+d.noq=a.calctype "+
	" where (c.noa is not null)"+
	" and (patindex('%option01%',@t_option)=0 or (patindex('%option01%',@t_option)>0 and isnull(b.option01,0)=1))"+
	" and isnull(d.isoutside,0)=0"+
	" and (a.trandate between @t_btrandate and @t_etrandate)"+
	" group by a.carno,a.trandate"
	
	insert into @tmp
	execute sp_executesql @cmd,N'@t_option nvarchar(max),@t_filter nvarchar(max),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)'
	,@t_option=@t_option,@t_filter=@t_filter,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	
	
	----------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carno,trandate,miles,tranmoney,drivermoney,reserve from @tmp
	open cursor_table
	fetch next from cursor_table
	into @carno,@trandate,@miles,@tranmoney,@drivermoney,@reserve
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set miles=@miles,tranmoney=@tranmoney,drivermoney=@drivermoney,reserve=@reserve where carno=@carno and trandate=@trandate
		
		fetch next from cursor_table
		into @carno,@trandate,@miles,@tranmoney,@drivermoney,@reserve
	end
	close cursor_table
	deallocate cursor_table
	
	-----------------------------------------------------------------------------------------------------------
	--油費
	declare cursor_table cursor for
	select a.carno,a.datea,SUM(isnull(a.mount,0)),SUM(isnull(a.[money],0))
	from oil a
	left join car2 b on a.carno=b.carno
	where (a.datea between @t_btrandate and @t_etrandate)
	and patindex('%option01%',@t_option)=0 or (patindex('%option01%',@t_option)>0 and isnull(b.option01,0)=1)
	group  by  a.carno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set oilmount=@mount,oilmoney=@money where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	--加油備註
	declare cursor_table cursor for
	select a.carno,a.datea,a.memo
	from oil a
	left join car2 b on a.carno=b.carno
	where len(isnull(a.memo,''))>1 --排除MEMO  =  .  的
	and (a.datea between @t_btrandate and @t_etrandate)
	and patindex('%option01%',@t_option)=0 or (patindex('%option01%',@t_option)>0 and isnull(b.option01,0)=1)
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@memo
	while(@@FETCH_STATUS <> -1)
	begin
		set @memo = case when left(@memo,1)='.' then SUBSTRING(@memo,1,LEN(@memo)) else @memo end
		update #z_tran01 set
		memo=ISNULL(memo,'')+case when len(ISNULL(memo,''))>0 then CHAR(59) else '' end + @memo
		where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@memo
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	--ETC
	declare cursor_table cursor for
	select a.carno,a.datea,SUM(isnull(a.[money],0))
	from etc a
	left join car2 b on a.carno=b.carno
	where (a.typea='ETC' or a.typea='CASH')
	and (a.datea between @t_btrandate and @t_etrandate)
	and patindex('%option01%',@t_option)=0 or (patindex('%option01%',@t_option)>0 and isnull(b.option01,0)=1)
	group  by  a.carno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@money
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set tolls=@money where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@money
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	--罰單
	declare cursor_table cursor for
	select a.carno,a.datea,SUM(isnull(a.comppay,0))
	from carborr a
	left join car2 b on a.carno=b.carno
	where comppay!=0
	and patindex('%option01%',@t_option)=0 or (patindex('%option01%',@t_option)>0 and isnull(b.option01,0)=1)
	and (a.datea between @t_btrandate and @t_etrandate)
	group  by  a.carno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@money
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set ticket=@money where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@money
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	update #z_tran01 set profit=ISNULL(tranmoney,0)-ISNULL(drivermoney,0)-ISNULL(oilmoney,0)-ISNULL(tolls,0)-ISNULL(ticket,0)-ISNULL(reserve,0)
	
	delete #z_tran01 where (isnull(tranmoney,0)=0 and isnull(oilmoney,0)=0 and @t_rate>0) or (isnull(tranmoney,0)!=0 and round(isnull(oilmoney,0)*100/isnull(tranmoney,0),0)<CAST(@t_rate as float))
	
	---------------------------------------------------------------------------------------------
	insert into #z_tran01(n,gno,carno,trandate,miles,tranmoney,drivermoney,oilmount,oilmoney,tolls,ticket,reserve,profit)
	select 2,'2',CHAR(255),CHAR(255),SUM(ISNULL(miles,0)),SUM(ISNULL(tranmoney,0)),SUM(ISNULL(drivermoney,0))
	,SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0)),SUM(ISNULL(tolls,0)),SUM(ISNULL(ticket,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(profit,0))
	from  #z_tran01 where gno='1'

	update #z_tran01 set rate1 = cast(case when isnull(tranmoney,0)=0 then 0 else round(isnull(oilmoney,0)*100/isnull(tranmoney,0),0) end as nvarchar)
	----------------------------------------------------------------------------------------------
	declare @driver nvarchar(40)
	declare @straddr nvarchar(40)
	declare @total float
	declare @str varchar(max)
	declare @bool bit
	declare @rate1 float
	declare @oilstation nvarchar(20)
	declare @price float
	declare @bmiles float
	declare @emiles float
	declare @oilmoney float
	declare @profit float
	if(patindex('%trans%',@t_filter)>0 or patindex('%oil%',@t_filter)>0)
	begin
		declare cursor_table cursor for
		select trandate,carkindno,carno,isnull(rate1,0),tranmoney,oilmoney,profit from #z_tran01 where gno='1'
		open cursor_table
		fetch next from cursor_table
		into @trandate,@carkindno,@carno,@rate1,@tranmoney,@oilmoney,@profit
		while(@@FETCH_STATUS <> -1)
		begin
			--出車明細
			set @bool = 0
			set @cmd ="if exists(select noa from view_trans"+@t_accy+" where carno=@carno and trandate=@trandate) set @bool = 1 else set @bool = 0"
			execute sp_executesql @cmd,N'@bool bit output,@carno nvarchar(20),@trandate nvarchar(10)',@bool=@bool output,@carno=@carno,@trandate=@trandate			
			if(@bool=1 and patindex('%trans%',@t_filter)>0)
			begin
				insert into #z_tran01(n,gno,trandate,carkindno,carno,rate1,tranmoney,oilmoney,profit,zdriver,zaddr,zmoney,zmiles)
				values(0,'3',@trandate,@carkindno,@carno,@rate1,@tranmoney,@oilmoney,@profit,'司機','起迄地點','收入','里程數')
				set @cmd =
				" declare cursor_table2 cursor for"+
				" select driver,straddr,total,miles from view_trans"+@t_accy+" where carno=@carno and trandate=@trandate"+
				" open cursor_table2"+
				" fetch next from cursor_table2"+
				" into @driver,@straddr,@total,@miles"+
				" while(@@FETCH_STATUS <> -1)"+
				" begin"+
				" 	insert into #z_tran01(n,gno,trandate,carkindno,carno,rate1,tranmoney,oilmoney,profit,zdriver,zaddr,zmoney,zmiles)"+
				"   values(0.1,'7',@trandate,@carkindno,@carno,@rate1,@tranmoney,@oilmoney,@profit,@driver,@straddr"+
				",reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@total,0)),1)),4,12))"+
				",reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@miles,0)),1)),4,12)))"+
				" 	fetch next from cursor_table2"+
				" 	into @driver,@straddr,@total,@miles"+
				" end"+
				" close cursor_table2"+
				" deallocate cursor_table2"
				execute sp_executesql @cmd,N'@profit float,@tranmoney float,@oilmoney float,@rate1 float,@carno nvarchar(20),@carkindno nvarchar(20),@trandate nvarchar(10),@driver nvarchar(20),@straddr nvarchar(40),@total float,@miles float,@str varchar(max)'
				,@profit=@profit,@tranmoney=@tranmoney,@oilmoney=@oilmoney,@rate1=@rate1,@carno=@carno,@carkindno=@carkindno,@trandate=@trandate,@driver=@driver,@straddr=@straddr,@total=@total,@miles=@miles,@str=@str
			end
			--加油明細
			set @bool = 0
			if exists(select noa from oil where carno=@carno and datea=@trandate )
				set @bool = 1
			else
				set @bool = 0
			if(@bool=1 and patindex('%oil%',@t_filter)>0)
			begin	
				insert into #z_tran01(n,gno,trandate,carkindno,carno,memo,rate1,tranmoney,oilmoney,profit
				,ystation,yprice,ymount,ymoney,ymiles,ybmiles,yemiles)
				values(0.2,'4',@trandate,@carkindno,@carno,@str,@rate1,@tranmoney,@oilmoney,@profit
				,'站名','公升','單價','金額','里程數','上次里程數','本次里程數')

				declare cursor_table2 cursor for
				select oilstation,price,mount,[money],bmiles,emiles,miles from oil where carno=@carno and datea=@trandate order by datea,timea
				open cursor_table2
				fetch next from cursor_table2
				into @oilstation,@price,@mount,@money,@bmiles,@emiles,@miles
				while(@@FETCH_STATUS <> -1)
				begin
					insert into #z_tran01(n,gno,trandate,carkindno,carno,rate1,tranmoney,oilmoney,profit
					,ystation,yprice,ymount,ymoney,ymiles,ybmiles,yemiles)
					values(0.21,'8',@trandate,@carkindno,@carno,@rate1,@tranmoney,@oilmoney,@profit
					,@oilstation
					,convert(nvarchar,CONVERT(money,isnull(@price,0)),1)
					,convert(nvarchar,CONVERT(money,isnull(@mount,0)),1)
					,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@money,0)),1)),4,12))
					,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@miles,0)),1)),4,12))
					,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@bmiles,0)),1)),4,12))
					,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@emiles,0)),1)),4,12)))
					fetch next from cursor_table2
					into @oilstation,@price,@mount,@money,@bmiles,@emiles,@miles
				end
				close cursor_table2
				deallocate cursor_table2
			end

			fetch next from cursor_table
			into @trandate,@carkindno,@carno,@rate1,@tranmoney,@oilmoney,@profit
		end
		close cursor_table
		deallocate cursor_table
	end
	----------------------------------------------------------------------------------------------
	update #z_tran01 set gno='5' where gno='1' and profit<0
	select @cmd = ''
	select @cmd = cast(COUNT(1) as nvarchar)+'車次' from #z_tran01 where gno='1' or gno='5'
	if @t_sort01 = 'trandate'
	begin
		insert into #z_tran01(n,gno,trandate,miles,tranmoney,drivermoney,oilmount,oilmoney,tolls,ticket,reserve,profit,rate1)
		select -1,'6',LEFT(trandate,6)+'小計'
		,SUM(ISNULL(miles,0)),SUM(ISNULL(tranmoney,0)),SUM(ISNULL(drivermoney,0))
		,SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0)),SUM(ISNULL(tolls,0))
		,SUM(ISNULL(ticket,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(profit,0))
		,case when sum(isnull(tranmoney,0))!=0 then round(sum(ISNULL(oilmoney,0))/sum(isnull(tranmoney,0))*100,0) else 0 end
		from #z_tran01
		where (gno='1' or gno='5')
		group by LEFT(trandate,6)
		
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(miles,0)),1)),4,12)) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  a.trandate,a.carkindno,b.caryear,a.carno,n
	end
	if @t_sort01 = 'rate1'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(miles,0)),1)),4,12)) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		,case when gno='2' then -999 when a.rate1=0 and a.oilmoney!=0 then (9999) else a.rate1 end sort01
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  sort01 desc,a.trandate,a.carkindno,b.caryear,a.carno,n
	end
	if @t_sort01 = 'tranmoney'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(miles,0)),1)),4,12)) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times		
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  (case when a.gno='2' then 9 else 1 end),a.tranmoney desc,a.trandate,a.carkindno,b.caryear,a.carno,n
	end
	if @t_sort01 = 'caryear'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(miles,0)),1)),4,12)) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  (case when a.gno='2' then 9 else 1 end),isnull(b.caryear,'') desc,a.carkindno,a.carno,a.trandate,n
	end
	if @t_sort01 = 'driverno'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(miles,0)),1)),4,12)) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  (case when a.gno='2' then 9 else 1 end),a.driverno,a.carkindno,a.carno,a.trandate,n
	end
	if @t_sort01 = 'profit'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(miles,0)),1)),4,12)) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  (case when a.gno='2' then 9 else 1 end),a.profit desc,a.trandate,a.carkindno,b.caryear,a.carno,n
	end
	----------------------------------------------------------------------------------------------
	drop table #carkind
	drop table #listDate
	drop table #z_tran01;
--------------------------------------------------------------------------------------------------------------------*
z_trans_tb03:--z_trans_tb03 ref:z_tran17
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	
	set @t_accy = '[19]'
	set @t_bdate = case when '#non'=[1] then '' else [1] end
	set @t_edate = case when '#non'=[2] then CHAR(255) else [2] end
	set @t_bdriverno = case when '#non'=[7] then '' else [7] end
	set @t_edriverno = case when '#non'=[8] then CHAR(255) else [8] end
	set @t_carno = case when '#non'=[9] then '' else [9] end
	set @t_option1  = case when '#non'=[20] then '' else [20] end
	set @t_carkind  = case when '#non'=[14] then '' else [14] end
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	-------------------------------------------------------------------------------------------------------------
	declare @carno  nvarchar(20)
	declare @driverno  nvarchar(20)
	declare @driver nvarchar(20)
	declare @mon nvarchar(10)
	declare @money float
	declare @tranmoney float
	declare @miles float
	declare @reserve  float
	declare @oilmount float
	declare @oilmoney float
	declare @fixa1 float
	declare @fixa2 float
	declare @tire1 float
	declare @tire2 float
	declare @driverpay float
	declare @tolls float
	declare @ticket float
	declare @carsal float
	declare @tax float
	declare @depreciation  float
	declare @profit  float
	declare @carkindno nvarchar(20)
	declare @carkind nvarchar(20)
	declare @caryear nvarchar(10)
	declare @day  int
	-------------------------------------------------------------------------------------------------------------
	--暫存資料
	IF OBJECT_ID('tempdb..#z_tran17')is not null
	BEGIN
		set @cmd = 'drop table #z_tran17'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran17(
		n float,
		gno nvarchar(3),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		carno nvarchar(20),
		caryear nvarchar(10),
		driverno nvarchar(20),
		driver nvarchar(20),
		mon nvarchar(20),
		[day] int,
		tranmoney float,
		miles float,
		oilmount float,
		oilmoney float,
		rate1 float,--油秏
		rate2 float,--公里/升
		fixa1 float,--車輛維修
		fixa2 float,--板台維修
		tire1 float,--車輛輪胎
		tire2 float,--板台輪胎
		driverpay  float,--司機維修自付
		tolls float,--通行費
		reserve float,--寄櫃費
		ticket float,--罰款
		carsal float,--薪資
		tax float,--保牌燃費
		depreciation float,--折舊
		profit float,--淨利
	)
	create index noa on #z_tran17(carno,driverno,mon)
	-------------------------------------------------------------------------------------------------------------------
	--出車單
	declare @tmp1 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		tranmoney  float,
		miles  float,
		reserve  float
	)	
	set @cmd=" select  a.carno,a.driverno,LEFT(a.datea,6)"
	if @t_option1='收金額'
		set @cmd=@cmd+" ,sum(round(ISNULL(a.price,0)*isnull(a.mount,0),0))"
	else
		set @cmd=@cmd+" ,sum(round(ISNULL(a.price2,0)*isnull(a.mount2,0),0))"
	set @cmd=@cmd+",sum(ISNULL(a.miles,0)),sum(ISNULL(a.reserve,0))"+
	" from view_trans"+@t_accy+" a "+ 
	" left  join  calctypes  b  on  b.noa+b.noq=a.calctype"+
	" where len(ISNULL(a.carno,''))>0 and  (b.noa is  not  null) and isnull(b.isoutside,0)=0"+
	" and (a.datea  between  @t_bdate  and  @t_edate)"+
	" group by a.carno,a.driverno,LEFT(a.datea,6)"+
	" order  by a.carno,LEFT(a.datea,6),a.driverno"
	
	insert into @tmp1
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10)',@t_bdate=@t_bdate,@t_edate=@t_edate
	-------------------------------------------------------------------------------------------------------------------
	--油費
	declare @tmp2 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		oilmount float,
		oilmoney float
	)
	insert into @tmp2
	select  carno,driverno,LEFT(datea,6),SUM(ISNULL(mount,0)),SUM(ISNULL([money],0))  
	from  oil
	where (datea between @t_bdate  and @t_edate)
	group  by  carno,driverno,LEFT(datea,6)
	order  by  carno,LEFT(datea,6),driverno
	-------------------------------------------------------------------------------------------------------------------
	--維修
	declare @tmp3 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		fixa1 float,--車輛維修
		fixa2 float,--板台維修
		tire1 float,--車輛輪胎
		tire2 float,--板台輪胎
		driverpay  float--司機維修自付
	)
	insert into @tmp3
	select  carno,driverno,left(datea,6)
	,SUM(case when len(isnull(carplateno,''))=0 then isnull(wmoney-discount,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))>0 then isnull(wmoney-discount,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))=0 then isnull(cmoney,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))>0 then isnull(cmoney,0) else 0  end) 
	,0
	from  fixa
	where (isnull(datea,'') between @t_bdate  and @t_edate)
	group  by carno,driverno,left(datea,6)
	order by carno,left(datea,6),driverno
	
	declare cursor_table cursor for
	select carno,driverno,left(datea,6)
	,sum(case when len(isnull(carplateno,''))=0  then isnull([money],0) else 0  end)
	,sum(case when len(isnull(carplateno,''))>0  then isnull([money],0) else 0  end)
	from fixout
	where (isnull(datea,'') between @t_bdate  and @t_edate)
	group  by carno,driverno,left(datea,6)
	order by carno,left(datea,6),driverno
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tire1,@tire2
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select  *  from @tmp3 where carno=@carno and driverno=@driverno and mon=@mon)
			insert into @tmp3(carno,driverno,mon,tire1,tire2)values(@carno,@driverno,@mon,@tire1,@tire2)
		else
			update @tmp3 set tire1=isnull(tire1,0)+@tire1,tire2=isnull(tire2,0)+@tire2  where carno=@carno and driverno=@driverno and mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tire1,@tire2
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,sum(isnull([money],0))
	from carborr
	where (mon between left(@t_bdate,6)  and left(@t_edate,6)) and  typea='維修'
	group  by carno,driverno,mon
	order by carno,mon,driverno
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select  *  from @tmp3 where carno=@carno and driverno=@driverno and mon=@mon)
			insert into @tmp3(carno,driverno,mon,driverpay)values(@carno,@driverno,@mon,@money)
		else
			update @tmp3 set driverpay=@money  where carno=@carno and driverno=@driverno and mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@money
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------------------------------------------------------------------------------
	--ETC
	declare @tmp4 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		tolls float
	)
	insert into @tmp4
	select carno,driverno,LEFT(datea,6),SUM(ISNULL([money],0))
	from etc
	where typea='ETC' and (datea between @t_bdate and @t_edate)
	group by carno,driverno,LEFT(datea,6)
	order by carno,LEFT(datea,6),driverno
	-------------------------------------------------------------------------------------------------------------------
	--罰款
	declare @tmp5 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		ticket float
	)
	insert into @tmp5
	select carno,driverno,mon,SUM(ISNULL(comppay,0)) 
	from carborr
	where typea='罰單' and  (mon between  left(@t_bdate,6) and LEFT(@t_edate,6))
	group  by  carno,driverno,mon
	order  by  carno,mon,driverno
	-------------------------------------------------------------------------------------------------------------------
	--薪資
	declare @tmp6 table(
		driverno  nvarchar(20),
		mon  nvarchar(10),
		carsal float
	)
	insert into @tmp6
	select driverno,noa,[money]
	from carsals
	where (noa between LEFT(@t_bdate,6) and LEFT(@t_edate,6))
	-------------------------------------------------------------------------------------------------------------------
	--保牌燃費,折舊 
	declare @tmp7 table(
		carno nvarchar(20),
		mon nvarchar(10),
		tax float,
		depreciation float
	)
	insert into @tmp7
	select  b.carno,a.mon,a.tax,a.depreciation
	from carts a  
	left join cart b on a.noa=b.noa
	where (len(ISNULL(b.carno,''))>0) and (a.mon between left(@t_bdate,6) and left(@t_edate,6))
	-------------------------------------------------------------------------------------------------------------------
	-------------------------------------------------------------------------------------------------------------------	
	declare cursor_table cursor for
	select carno,driverno,mon,tranmoney,miles,reserve from @tmp1
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tranmoney,@miles,@reserve
	while(@@FETCH_STATUS <> -1)
	begin
		insert into #z_tran17 (n,carno,driverno,mon,tranmoney,miles,reserve)values(0,@carno,@driverno,@mon,@tranmoney,@miles,@reserve)
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tranmoney,@miles,@reserve
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,oilmount,oilmoney from @tmp2
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@oilmount,@oilmoney
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran17 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran17 (n,carno,driverno,mon,oilmount,oilmoney)values(0,@carno,@driverno,@mon,@oilmount,@oilmoney)
		else
			update #z_tran17 set oilmount=@oilmount,oilmoney=@oilmoney where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@oilmount,@oilmoney
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,fixa1,fixa2,tire1,tire2,driverpay from @tmp3
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran17 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran17 (n,carno,driverno,mon,fixa1,fixa2,tire1,tire2,driverpay)values(0,@carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay)
		else
			update #z_tran17 set fixa1=isnull(fixa1,0)+@fixa1,fixa2=isnull(fixa2,0)+@fixa2
			,tire1=isnull(tire1,0)+@tire1,tire2=isnull(tire2,0)+@tire2,driverpay=isnull(driverpay,0)+@driverpay 
			where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,tolls from @tmp4
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tolls
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran17 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran17 (n,carno,driverno,mon,tolls)values(0,@carno,@driverno,@mon,@tolls)
		else
			update #z_tran17 set tolls=isnull(tolls,0)+@tolls where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tolls
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,ticket from @tmp5
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@ticket
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran17 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran17 (n,carno,driverno,mon,ticket)values(0,@carno,@driverno,@mon,@ticket)
		else
			update #z_tran17 set ticket=@ticket where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@ticket
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select driverno,mon,carsal from @tmp6
	open cursor_table
	fetch next from cursor_table
	into @driverno,@mon,@carsal
	while(@@FETCH_STATUS <> -1)
	begin
		select @carno=''
		select top(1) @carno=carno from #z_tran17 where driverno=@driverno and mon=@mon order by tranmoney desc
		if LEN(@carno)>0
		begin
			update #z_tran17 set carsal=@carsal where carno=@carno  and  driverno=@driverno and  mon=@mon
		end
		fetch next from cursor_table
		into @driverno,@mon,@carsal
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,mon,tax,depreciation from @tmp7
	open cursor_table
	fetch next from cursor_table
	into @carno,@mon,@tax,@depreciation
	while(@@FETCH_STATUS <> -1)
	begin
		select @driverno=''
		select top(1) @driverno=driverno from #z_tran17 where carno=@carno and mon=@mon order by tranmoney desc
		if LEN(@driverno)>0
		begin
			update #z_tran17 set tax=@tax,depreciation=@depreciation where carno=@carno  and  driverno=@driverno and  mon=@mon
		end
		fetch next from cursor_table
		into @carno,@mon,@tax,@depreciation
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carno from #z_tran17 group  by  carno
	open cursor_table
	fetch next from cursor_table
	into @carno
	while(@@FETCH_STATUS <> -1)
	begin
		select @carkindno='',@carKind='',@caryear=''
		select @carkindno=a.carkindno,@carKind=b.kind,@caryear=a.caryear 
		from car2 a left join carkind b on  a.carkindno=b.noa
		where carno=@carno
		update #z_tran17 set carkindno=@carkindno,carkind=@carkind,caryear=@caryear where carno=@carno
		
		fetch next from cursor_table
		into @carno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select driverno from #z_tran17 group by driverno
	open cursor_table
	fetch next from cursor_table
	into @driverno
	while(@@FETCH_STATUS <> -1)
	begin
		select @driver=''
		select @driver=namea from driver where noa=@driverno
		update #z_tran17 set driver=@driver where driverno=@driverno
		
		fetch next from cursor_table
		into @driverno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon from #z_tran17 group by carno,driverno,mon
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon
	while(@@FETCH_STATUS <> -1)
	begin
		select @day=0
		set @cmd="select @day=count(1) from (SELECT DISTINCT datea from view_trans"+@t_accy+" where carno=@carno and driverno=@driverno and LEFT(datea,6)=@mon)as a"
		execute sp_executesql @cmd,N'@carno  nvarchar(20),@driverno  nvarchar(20),@mon nvarchar(10),@day  int  output'
		,@carno=@carno,@driverno=@driverno,@mon=@mon,@day=@day  output
		
		update #z_tran17  set  [day]=@day where carno=@carno and driverno=@driverno and mon=@mon  
		fetch next from cursor_table
		into @carno,@driverno,@mon
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carkindno from #z_tran17 group by carkindno
	open cursor_table
	fetch next from cursor_table
	into @carkindno
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select * from #carkind where noa=@carkindno)
			delete #z_tran17 where carkindno=@carkindno
		fetch next from cursor_table
		into @carkindno
	end
	close cursor_table
	deallocate cursor_table
	
	if LEN(@t_carno)>0
		delete #z_tran17 where carno!=@t_carno
	delete #z_tran17 where not(driverno between @t_bdriverno and @t_edriverno)
	update #z_tran17 set gno='0' 
	
	insert into #z_tran17
	select 1,'1',carkindno,carKind,CHAR(255),'','','','','',SUM(ISNULL(tranmoney,0)),SUM(ISNULL(miles,0)),SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0))
	,0,0,SUM(ISNULL(fixa1,0)),SUM(ISNULL(fixa2,0)),SUM(ISNULL(tire1,0)),SUM(ISNULL(tire2,0)),SUM(ISNULL(driverpay,0))
	,SUM(ISNULL(tolls,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(ticket,0)),SUM(ISNULL(carsal,0)),SUM(ISNULL(tax,0)),SUM(ISNULL(depreciation,0)),0
	from #z_tran17 where gno='0'group by carkindno,carkind
	
	update #z_tran17  set rate1= case when isnull(tranmoney,0)=0  then 0 else round(ISNULL(oilmoney,0)/tranmoney*100,0) end
	,rate2= case when isnull(oilmount,0)=0  then 0 else round(ISNULL(miles,0)/oilmount,3) end
	,profit=ISNULL(tranmoney,0)-ISNULL(oilmoney,0)-ISNULL(fixa1,0)-ISNULL(fixa2,0)-isnull(tire1,0)-ISNULL(tire2,0)+ISNULL(driverpay,0)
	-ISNULL(tolls,0)-ISNULL(reserve,0)-ISNULL(ticket,0)-ISNULL(carsal,0)-ISNULL(tax,0)-ISNULL(depreciation,0)
	---------------------------------------------------------------------------------------------------------------------
	
	update #z_tran17 set gno='2' where gno='0' and profit<0
	
	select * 
	,caryear m01
	,cast(rate1 as nvarchar)+'%' m02
	,[day] m03
	,cast(rate2 as decimal(10,3)) m04
	,carno m05
	,driver m06
	,mon m07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) m08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12)) m09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) m10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa1,0)),1)),4,12)) m11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa2,0)),1)),4,12)) m12
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire1,0)),1)),4,12)) m13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire2,0)),1)),4,12)) m14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(driverpay,0)),1)),4,12))  m15
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) m16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) m17
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(reserve,0)),1)),4,12)) m18
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carsal,0)),1)),4,12)) m19
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tax,0)),1)),4,12)) m20
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(depreciation,0)),1)),4,12)) m21
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(profit,0)),1)),4,12)) m22
	from #z_tran17 order  by  carkindno,n,caryear,carno;
--------------------------------------------------------------------------------------------------------------------*
z_trans_tb04:--z_trans_tb04 ref z_tran24
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	
	set @t_accy = '[19]'
	set @t_bdate = case when '#non'=[1] then '' else [1] end
	set @t_edate = case when '#non'=[2] then CHAR(255) else [2] end
	set @t_bdriverno = case when '#non'=[7] then '' else [7] end
	set @t_edriverno = case when '#non'=[8] then CHAR(255) else [8] end
	set @t_carno = case when '#non'=[9] then '' else [9] end
	set @t_option1  = case when '#non'=[20] then '' else [20] end
	set @t_carkind  = case when '#non'=[14] then '' else [14] end
	---------------------------------------------------------------------------------------------- 
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	-------------------------------------------------------------------------------------------------------------
	declare @carno  nvarchar(20)
	declare @driverno  nvarchar(20)
	declare @driver nvarchar(20)
	declare @mon nvarchar(10)
	declare @money float
	declare @tranmoney float
	declare @miles float
	declare @reserve  float
	declare @oilmount float
	declare @oilmoney float
	declare @fixa1 float
	declare @fixa2 float
	declare @tire1 float
	declare @tire2 float
	declare @driverpay float
	declare @tolls float
	declare @ticket float
	declare @carsal float
	declare @tax float
	declare @depreciation  float
	declare @profit  float
	declare @carkindno nvarchar(20)
	declare @carkind nvarchar(20)
	declare @caryear nvarchar(10)
	declare @day  int
	-------------------------------------------------------------------------------------------------------------
	--暫存資料
	IF OBJECT_ID('tempdb..#z_tran24')is not null
	BEGIN
		set @cmd = 'drop table #z_tran24'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran24(
		gno nvarchar(3),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		carno nvarchar(20),
		caryear nvarchar(10),
		driverno nvarchar(20),
		driver nvarchar(20),
		mon nvarchar(20),
		[day] int,
		tranmoney float,
		miles float,
		oilmount float,
		oilmoney float,
		rate1 float,--油秏
		rate2 float,--公里/升
		fixa1 float,--車輛維修
		fixa2 float,--板台維修
		tire1 float,--車輛輪胎
		tire2 float,--板台輪胎
		driverpay  float,--司機維修自付
		tolls float,--通行費
		reserve float,--寄櫃費
		ticket float,--罰款
		carsal float,--薪資
		tax float,--保牌燃費
		depreciation float,--折舊
		profit float,--淨利
	)
	create index noa on #z_tran24(carno,driverno,mon)
	-------------------------------------------------------------------------------------------------------------------
	--出車單
	declare @tmp1 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		tranmoney  float,
		miles  float,
		reserve  float
	)	
	set @cmd=" select  a.carno,a.driverno,LEFT(a.datea,6)"
	if @t_option1='收金額'
		set @cmd=@cmd+" ,sum(round(ISNULL(a.price,0)*isnull(a.mount,0),0))"
	else
		set @cmd=@cmd+" ,sum(round(ISNULL(a.price2,0)*isnull(a.mount2,0),0))"
	set @cmd=@cmd+",sum(ISNULL(a.miles,0)),sum(ISNULL(a.reserve,0))"+
	" from view_trans"+@t_accy+" a "+ 
	" left  join  calctypes  b  on  b.noa+b.noq=a.calctype"+
	" where len(ISNULL(a.carno,''))>0 and  (b.noa is  not  null) and isnull(b.isoutside,0)=0"+
	" and (a.datea  between  @t_bdate  and  @t_edate)"+
	" group by a.carno,a.driverno,LEFT(a.datea,6)"+
	" order  by a.carno,LEFT(a.datea,6),a.driverno"
	
	insert into @tmp1
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10)',@t_bdate=@t_bdate,@t_edate=@t_edate
	-------------------------------------------------------------------------------------------------------------------
	--油費
	declare @tmp2 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		oilmount float,
		oilmoney float
	)
	insert into @tmp2
	select  carno,driverno,LEFT(datea,6),SUM(ISNULL(mount,0)),SUM(ISNULL([money],0))  
	from  oil
	where (datea between @t_bdate  and @t_edate)
	group  by  carno,driverno,LEFT(datea,6)
	order  by  carno,LEFT(datea,6),driverno
	-------------------------------------------------------------------------------------------------------------------
	--維修
	declare @tmp3 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		fixa1 float,--車輛維修
		fixa2 float,--板台維修
		tire1 float,--車輛輪胎
		tire2 float,--板台輪胎
		driverpay  float--司機維修自付
	)
	insert into @tmp3
	select  carno,driverno,mon
	,SUM(case when len(isnull(carplateno,''))=0 then isnull(wmoney-discount,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))>0 then isnull(wmoney-discount,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))=0 then isnull(cmoney,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))>0 then isnull(cmoney,0) else 0  end) 
	,0
	from  fixa
	where (mon between left(@t_bdate,6)  and left(@t_edate,6))
	group  by carno,driverno,mon
	order by carno,mon,driverno
	
	declare cursor_table cursor for
	select carno,driverno,mon
	,sum(case when len(isnull(carplateno,''))=0  then isnull([money],0) else 0  end)
	,sum(case when len(isnull(carplateno,''))>0  then isnull([money],0) else 0  end)
	from fixout
	where (mon between left(@t_bdate,6)  and left(@t_edate,6)) 
	group  by carno,driverno,mon
	order by carno,mon,driverno
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tire1,@tire2
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select  *  from @tmp3 where carno=@carno and driverno=@driverno and mon=@mon)
			insert into @tmp3(carno,driverno,mon,tire1,tire2)values(@carno,@driverno,@mon,@tire1,@tire2)
		else
			update @tmp3 set tire1=isnull(tire1,0)+@tire1,tire2=isnull(tire2,0)+@tire2  where carno=@carno and driverno=@driverno and mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tire1,@tire2
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,sum(isnull([money],0))
	from carborr
	where (mon between left(@t_bdate,6)  and left(@t_edate,6)) and  typea='維修'
	group  by carno,driverno,mon
	order by carno,mon,driverno
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select  *  from @tmp3 where carno=@carno and driverno=@driverno and mon=@mon)
			insert into @tmp3(carno,driverno,mon,driverpay)values(@carno,@driverno,@mon,@money)
		else
			update @tmp3 set driverpay=@money  where carno=@carno and driverno=@driverno and mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@money
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------------------------------------------------------------------------------
	--ETC
	declare @tmp4 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		tolls float
	)
	insert into @tmp4
	select carno,driverno,LEFT(datea,6),SUM(ISNULL([money],0))
	from etc
	where typea='ETC' and (datea between @t_bdate and @t_edate)
	group by carno,driverno,LEFT(datea,6)
	order by carno,LEFT(datea,6),driverno
	-------------------------------------------------------------------------------------------------------------------
	--罰款
	declare @tmp5 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		ticket float
	)
	insert into @tmp5
	select carno,driverno,mon,SUM(ISNULL(comppay,0)) 
	from carborr
	where typea='罰單' and  (mon between  left(@t_bdate,6) and LEFT(@t_edate,6))
	group  by  carno,driverno,mon
	order  by  carno,mon,driverno
	-------------------------------------------------------------------------------------------------------------------
	--薪資
	declare @tmp6 table(
		driverno  nvarchar(20),
		mon  nvarchar(10),
		carsal float
	)
	insert into @tmp6
	select driverno,noa,[money]
	from carsals
	where (noa between LEFT(@t_bdate,6) and LEFT(@t_edate,6))
	-------------------------------------------------------------------------------------------------------------------
	--保牌燃費,折舊 
	declare @tmp7 table(
		carno nvarchar(20),
		mon nvarchar(10),
		tax float,
		depreciation float
	)
	insert into @tmp7
	select  b.carno,a.mon,a.tax,a.depreciation
	from carts a  
	left join cart b on a.noa=b.noa
	where (len(ISNULL(b.carno,''))>0) and (a.mon between left(@t_bdate,6) and left(@t_edate,6))
	-------------------------------------------------------------------------------------------------------------------
	-------------------------------------------------------------------------------------------------------------------	
	declare cursor_table cursor for
	select carno,driverno,mon,tranmoney,miles,reserve from @tmp1
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tranmoney,@miles,@reserve
	while(@@FETCH_STATUS <> -1)
	begin
		insert into #z_tran24 (carno,driverno,mon,tranmoney,miles,reserve)values(@carno,@driverno,@mon,@tranmoney,@miles,@reserve)
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tranmoney,@miles,@reserve
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,oilmount,oilmoney from @tmp2
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@oilmount,@oilmoney
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran24 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran24 (carno,driverno,mon,oilmount,oilmoney)values(@carno,@driverno,@mon,@oilmount,@oilmoney)
		else
			update #z_tran24 set oilmount=@oilmount,oilmoney=@oilmoney where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@oilmount,@oilmoney
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,fixa1,fixa2,tire1,tire2,driverpay from @tmp3
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran24 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran24 (carno,driverno,mon,fixa1,fixa2,tire1,tire2,driverpay)values(@carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay)
		else
			update #z_tran24 set fixa1=isnull(fixa1,0)+@fixa1,fixa2=isnull(fixa2,0)+@fixa2
			,tire1=isnull(tire1,0)+@tire1,tire2=isnull(tire2,0)+@tire2,driverpay=isnull(driverpay,0)+@driverpay 
			where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,tolls from @tmp4
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tolls
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran24 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran24 (carno,driverno,mon,tolls)values(@carno,@driverno,@mon,@tolls)
		else
			update #z_tran24 set tolls=isnull(tolls,0)+@tolls where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tolls
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,ticket from @tmp5
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@ticket
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran24 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran24 (carno,driverno,mon,ticket)values(@carno,@driverno,@mon,@ticket)
		else
			update #z_tran24 set ticket=@ticket where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@ticket
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select driverno,mon,carsal from @tmp6
	open cursor_table
	fetch next from cursor_table
	into @driverno,@mon,@carsal
	while(@@FETCH_STATUS <> -1)
	begin
		select @carno=''
		select top(1) @carno=carno from #z_tran24 where driverno=@driverno and mon=@mon order by tranmoney desc
		if LEN(@carno)>0
		begin
			update #z_tran24 set carsal=@carsal where carno=@carno  and  driverno=@driverno and  mon=@mon
		end
		fetch next from cursor_table
		into @driverno,@mon,@carsal
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,mon,tax,depreciation from @tmp7
	open cursor_table
	fetch next from cursor_table
	into @carno,@mon,@tax,@depreciation
	while(@@FETCH_STATUS <> -1)
	begin
		select @driverno=''
		select top(1) @driverno=driverno from #z_tran24 where carno=@carno and mon=@mon order by tranmoney desc
		if LEN(@driverno)>0
		begin
			update #z_tran24 set tax=@tax,depreciation=@depreciation where carno=@carno  and  driverno=@driverno and  mon=@mon
		end
		fetch next from cursor_table
		into @carno,@mon,@tax,@depreciation
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carno from #z_tran24 group  by  carno
	open cursor_table
	fetch next from cursor_table
	into @carno
	while(@@FETCH_STATUS <> -1)
	begin
		select @carkindno='',@carKind='',@caryear=''
		select @carkindno=a.carkindno,@carKind=b.kind,@caryear=a.caryear 
		from car2 a left join carkind b on  a.carkindno=b.noa
		where carno=@carno
		update #z_tran24 set carkindno=@carkindno,carkind=@carkind,caryear=@caryear where carno=@carno
		
		fetch next from cursor_table
		into @carno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select driverno from #z_tran24 group by driverno
	open cursor_table
	fetch next from cursor_table
	into @driverno
	while(@@FETCH_STATUS <> -1)
	begin
		select @driver=''
		select @driver=namea from driver where noa=@driverno
		update #z_tran24 set driver=@driver where driverno=@driverno
		
		fetch next from cursor_table
		into @driverno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon from #z_tran24 group by carno,driverno,mon
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon
	while(@@FETCH_STATUS <> -1)
	begin
		select @day=0
		set @cmd="select @day=count(1) from (SELECT DISTINCT datea from view_trans"+@t_accy+" where carno=@carno and driverno=@driverno and LEFT(datea,6)=@mon)as a"
		execute sp_executesql @cmd,N'@carno  nvarchar(20),@driverno  nvarchar(20),@mon nvarchar(10),@day  int  output'
		,@carno=@carno,@driverno=@driverno,@mon=@mon,@day=@day  output
		
		update #z_tran24  set  [day]=@day where carno=@carno and driverno=@driverno and mon=@mon  
		fetch next from cursor_table
		into @carno,@driverno,@mon
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carkindno from #z_tran24 group by carkindno
	open cursor_table
	fetch next from cursor_table
	into @carkindno
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select * from #carkind where noa=@carkindno)
			delete #z_tran24 where carkindno=@carkindno
		fetch next from cursor_table
		into @carkindno
	end
	close cursor_table
	deallocate cursor_table
	
	if LEN(@t_carno)>0
		delete #z_tran24 where carno!=@t_carno
	delete #z_tran24 where not(driverno between @t_bdriverno and @t_edriverno)
	update #z_tran24 set gno='0' 
	-------------------------------------------------------------------
	insert into #z_tran24
	select '2',carkindno,carkind,carno,caryear,'','',mon,'',SUM(isnull(tranmoney,0)),SUM(isnull(miles,0)),SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0))
	,null,null,SUM(ISNULL(fixa1,0)),SUM(ISNULL(fixa2,0)),SUM(ISNULL(tire1,0)),SUM(ISNULL(tire2,0)),SUM(ISNULL(driverpay,0))
	,SUM(ISNULL(tolls,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(ticket,0)),SUM(ISNULL(carsal,0)),SUM(ISNULL(tax,0)),SUM(ISNULL(depreciation,0)),null
	from #z_tran24 group by carkindno,carkind,carno,caryear,mon
	
	delete #z_tran24 where gno='0'
	update #z_tran24 set gno='0' where gno='2'
	-------------------------------------------------------------------
	
	insert into #z_tran24
	select '1',carkindno,carKind,CHAR(255),'','','','','',SUM(ISNULL(tranmoney,0)),SUM(ISNULL(miles,0)),SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0))
	,0,0,SUM(ISNULL(fixa1,0)),SUM(ISNULL(fixa2,0)),SUM(ISNULL(tire1,0)),SUM(ISNULL(tire2,0)),SUM(ISNULL(driverpay,0))
	,SUM(ISNULL(tolls,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(ticket,0)),SUM(ISNULL(carsal,0)),SUM(ISNULL(tax,0)),SUM(ISNULL(depreciation,0)),0
	from #z_tran24 where gno='0'group by carkindno,carkind
	
	update #z_tran24  set rate1= case when isnull(tranmoney,0)=0  then 0 else round(ISNULL(oilmoney,0)/tranmoney*100,0) end
	,rate2= case when isnull(oilmount,0)=0  then 0 else round(ISNULL(miles,0)/oilmount,3) end
	,profit=ISNULL(tranmoney,0)-ISNULL(oilmoney,0)-ISNULL(fixa1,0)-ISNULL(fixa2,0)-isnull(tire1,0)-ISNULL(tire2,0)+ISNULL(driverpay,0)
	-ISNULL(tolls,0)-ISNULL(reserve,0)-ISNULL(ticket,0)-ISNULL(carsal,0)-ISNULL(tax,0)-ISNULL(depreciation,0)
	---------------------------------------------------------------------------------------------------------------------
	select * 
	,caryear m01
	,cast(rate1 as nvarchar)+'%' m02
	,[day] m03
	,cast(rate2 as decimal(10,3)) m04
	,carno m05
	,driver m06
	,mon m07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) m08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12)) m09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) m10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa1,0)),1)),4,12)) m11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa2,0)),1)),4,12)) m12
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire1,0)),1)),4,12)) m13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire2,0)),1)),4,12)) m14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(driverpay,0)),1)),4,12))  m15
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) m16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) m17
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(reserve,0)),1)),4,12)) m18
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carsal,0)),1)),4,12)) m19
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tax,0)),1)),4,12)) m20
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(depreciation,0)),1)),4,12)) m21
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(profit,0)),1)),4,12)) m22
	from #z_tran24 order  by  carkindno,gno,caryear,carno;
--------------------------------------------------------------------------------------------------------------------*
z_trans_tb05:--z_trans_tb05 ref z_tran26
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	
	set @t_accy = '[19]'
	set @t_bdate = case when '#non'=[1] then '' else [1] end
	set @t_edate = case when '#non'=[2] then CHAR(255) else [2] end
	set @t_bdriverno = case when '#non'=[7] then '' else [7] end
	set @t_edriverno = case when '#non'=[8] then CHAR(255) else [8] end
	set @t_carno = case when '#non'=[9] then '' else [9] end
	set @t_option1  = case when '#non'=[20] then '' else [20] end
	set @t_carkind  = case when '#non'=[14] then '' else [14] end
	---------------------------------------------------------------------------------------------- 
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	-------------------------------------------------------------------------------------------------------------
	declare @carno  nvarchar(20)
	declare @driverno  nvarchar(20)
	declare @driver nvarchar(20)
	declare @mon nvarchar(10)
	declare @money float
	declare @tranmoney float
	declare @miles float
	declare @reserve  float
	declare @oilmount float
	declare @oilmoney float
	declare @fixa1 float
	declare @fixa2 float
	declare @tire1 float
	declare @tire2 float
	declare @driverpay float
	declare @tolls float
	declare @ticket float
	declare @carsal float
	declare @tax float
	declare @depreciation  float
	declare @profit  float
	declare @carkindno nvarchar(20)
	declare @carkind nvarchar(20)
	declare @caryear nvarchar(10)
	declare @day  int
	-------------------------------------------------------------------------------------------------------------
	--暫存資料
	IF OBJECT_ID('tempdb..#z_tran26')is not null
	BEGIN
		set @cmd = 'drop table #z_tran26'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran26(
		gno nvarchar(3),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		carno nvarchar(20),
		caryear nvarchar(10),
		driverno nvarchar(20),
		driver nvarchar(20),
		mon nvarchar(20),
		[day] int,
		tranmoney float,
		miles float,
		oilmount float,
		oilmoney float,
		rate1 float,--油秏
		rate2 float,--公里/升
		fixa1 float,--車輛維修
		fixa2 float,--板台維修
		tire1 float,--車輛輪胎
		tire2 float,--板台輪胎
		driverpay  float,--司機維修自付
		tolls float,--通行費
		reserve float,--寄櫃費
		ticket float,--罰款
		carsal float,--薪資
		tax float,--保牌燃費
		depreciation float,--折舊
		profit float,--淨利
	)
	create index noa on #z_tran26(carno,driverno,mon)
	-------------------------------------------------------------------------------------------------------------------
	--出車單
	declare @tmp1 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		tranmoney  float,
		miles  float,
		reserve  float
	)	
	set @cmd=" select  a.carno,a.driverno,LEFT(a.datea,6)"
	if @t_option1='收金額'
		set @cmd=@cmd+" ,sum(round(ISNULL(a.price,0)*isnull(a.mount,0),0))"
	else
		set @cmd=@cmd+" ,sum(round(ISNULL(a.price2,0)*isnull(a.mount2,0),0))"
	set @cmd=@cmd+",sum(ISNULL(a.miles,0)),sum(ISNULL(a.reserve,0))"+
	" from view_trans"+@t_accy+" a "+ 
	" left  join  calctypes  b  on  b.noa+b.noq=a.calctype"+
	" where len(ISNULL(a.carno,''))>0 and  (b.noa is  not  null) and isnull(b.isoutside,0)=0"+
	" and (a.datea  between  @t_bdate  and  @t_edate)"+
	" group by a.carno,a.driverno,LEFT(a.datea,6)"+
	" order  by a.carno,LEFT(a.datea,6),a.driverno"
	
	insert into @tmp1
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10)',@t_bdate=@t_bdate,@t_edate=@t_edate
	-------------------------------------------------------------------------------------------------------------------
	--油費
	declare @tmp2 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		oilmount float,
		oilmoney float
	)
	insert into @tmp2
	select  carno,driverno,LEFT(datea,6),SUM(ISNULL(mount,0)),SUM(ISNULL([money],0))  
	from  oil
	where (datea between @t_bdate  and @t_edate)
	group  by  carno,driverno,LEFT(datea,6)
	order  by  carno,LEFT(datea,6),driverno
	-------------------------------------------------------------------------------------------------------------------
	--維修
	declare @tmp3 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		fixa1 float,--車輛維修
		fixa2 float,--板台維修
		tire1 float,--車輛輪胎
		tire2 float,--板台輪胎
		driverpay  float--司機維修自付
	)
	insert into @tmp3
	select  carno,driverno,mon
	,SUM(case when len(isnull(carplateno,''))=0 then isnull(wmoney-discount,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))>0 then isnull(wmoney-discount,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))=0 then isnull(cmoney,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))>0 then isnull(cmoney,0) else 0  end) 
	,0
	from  fixa
	where (mon between left(@t_bdate,6)  and left(@t_edate,6))
	group  by carno,driverno,mon
	order by carno,mon,driverno
	
	declare cursor_table cursor for
	select carno,driverno,mon
	,sum(case when len(isnull(carplateno,''))=0  then isnull([money],0) else 0  end)
	,sum(case when len(isnull(carplateno,''))>0  then isnull([money],0) else 0  end)
	from fixout
	where (mon between left(@t_bdate,6)  and left(@t_edate,6)) 
	group  by carno,driverno,mon
	order by carno,mon,driverno
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tire1,@tire2
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select  *  from @tmp3 where carno=@carno and driverno=@driverno and mon=@mon)
			insert into @tmp3(carno,driverno,mon,tire1,tire2)values(@carno,@driverno,@mon,@tire1,@tire2)
		else
			update @tmp3 set tire1=isnull(tire1,0)+@tire1,tire2=isnull(tire2,0)+@tire2  where carno=@carno and driverno=@driverno and mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tire1,@tire2
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,sum(isnull([money],0))
	from carborr
	where (mon between left(@t_bdate,6)  and left(@t_edate,6)) and  typea='維修'
	group  by carno,driverno,mon
	order by carno,mon,driverno
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select  *  from @tmp3 where carno=@carno and driverno=@driverno and mon=@mon)
			insert into @tmp3(carno,driverno,mon,driverpay)values(@carno,@driverno,@mon,@money)
		else
			update @tmp3 set driverpay=@money  where carno=@carno and driverno=@driverno and mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@money
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------------------------------------------------------------------------------
	--ETC
	declare @tmp4 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		tolls float
	)
	insert into @tmp4
	select carno,driverno,LEFT(datea,6),SUM(ISNULL([money],0))
	from etc
	where typea='ETC' and (datea between @t_bdate and @t_edate)
	group by carno,driverno,LEFT(datea,6)
	order by carno,LEFT(datea,6),driverno
	-------------------------------------------------------------------------------------------------------------------
	--罰款
	declare @tmp5 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		ticket float
	)
	insert into @tmp5
	select carno,driverno,mon,SUM(ISNULL(comppay,0)) 
	from carborr
	where typea='罰單' and  (mon between  left(@t_bdate,6) and LEFT(@t_edate,6))
	group  by  carno,driverno,mon
	order  by  carno,mon,driverno
	-------------------------------------------------------------------------------------------------------------------
	--薪資
	declare @tmp6 table(
		driverno  nvarchar(20),
		mon  nvarchar(10),
		carsal float
	)
	insert into @tmp6
	select driverno,noa,[money]
	from carsals
	where (noa between LEFT(@t_bdate,6) and LEFT(@t_edate,6))
	-------------------------------------------------------------------------------------------------------------------
	--保牌燃費,折舊 
	declare @tmp7 table(
		carno nvarchar(20),
		mon nvarchar(10),
		tax float,
		depreciation float
	)
	insert into @tmp7
	select  b.carno,a.mon,a.tax,a.depreciation
	from carts a  
	left join cart b on a.noa=b.noa
	where (len(ISNULL(b.carno,''))>0) and (a.mon between left(@t_bdate,6) and left(@t_edate,6))
	-------------------------------------------------------------------------------------------------------------------
	-------------------------------------------------------------------------------------------------------------------	
	declare cursor_table cursor for
	select carno,driverno,mon,tranmoney,miles,reserve from @tmp1
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tranmoney,@miles,@reserve
	while(@@FETCH_STATUS <> -1)
	begin
		insert into #z_tran26 (carno,driverno,mon,tranmoney,miles,reserve)values(@carno,@driverno,@mon,@tranmoney,@miles,@reserve)
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tranmoney,@miles,@reserve
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,oilmount,oilmoney from @tmp2
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@oilmount,@oilmoney
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran26 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran26 (carno,driverno,mon,oilmount,oilmoney)values(@carno,@driverno,@mon,@oilmount,@oilmoney)
		else
			update #z_tran26 set oilmount=@oilmount,oilmoney=@oilmoney where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@oilmount,@oilmoney
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,fixa1,fixa2,tire1,tire2,driverpay from @tmp3
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran26 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran26 (carno,driverno,mon,fixa1,fixa2,tire1,tire2,driverpay)values(@carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay)
		else
			update #z_tran26 set fixa1=isnull(fixa1,0)+@fixa1,fixa2=isnull(fixa2,0)+@fixa2
			,tire1=isnull(tire1,0)+@tire1,tire2=isnull(tire2,0)+@tire2,driverpay=isnull(driverpay,0)+@driverpay 
			where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,tolls from @tmp4
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tolls
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran26 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran26 (carno,driverno,mon,tolls)values(@carno,@driverno,@mon,@tolls)
		else
			update #z_tran26 set tolls=isnull(tolls,0)+@tolls where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tolls
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,ticket from @tmp5
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@ticket
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran26 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran26 (carno,driverno,mon,ticket)values(@carno,@driverno,@mon,@ticket)
		else
			update #z_tran26 set ticket=@ticket where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@ticket
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select driverno,mon,carsal from @tmp6
	open cursor_table
	fetch next from cursor_table
	into @driverno,@mon,@carsal
	while(@@FETCH_STATUS <> -1)
	begin
		select @carno=''
		select top(1) @carno=carno from #z_tran26 where driverno=@driverno and mon=@mon order by tranmoney desc
		if LEN(@carno)>0
		begin
			update #z_tran26 set carsal=@carsal where carno=@carno  and  driverno=@driverno and  mon=@mon
		end
		fetch next from cursor_table
		into @driverno,@mon,@carsal
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,mon,tax,depreciation from @tmp7
	open cursor_table
	fetch next from cursor_table
	into @carno,@mon,@tax,@depreciation
	while(@@FETCH_STATUS <> -1)
	begin
		select @driverno=''
		select top(1) @driverno=driverno from #z_tran26 where carno=@carno and mon=@mon order by tranmoney desc
		if LEN(@driverno)>0
		begin
			update #z_tran26 set tax=@tax,depreciation=@depreciation where carno=@carno  and  driverno=@driverno and  mon=@mon
		end
		fetch next from cursor_table
		into @carno,@mon,@tax,@depreciation
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carno from #z_tran26 group  by  carno
	open cursor_table
	fetch next from cursor_table
	into @carno
	while(@@FETCH_STATUS <> -1)
	begin
		select @carkindno='',@carKind='',@caryear=''
		select @carkindno=a.carkindno,@carKind=b.kind,@caryear=a.caryear 
		from car2 a left join carkind b on  a.carkindno=b.noa
		where carno=@carno
		update #z_tran26 set carkindno=@carkindno,carkind=@carkind,caryear=@caryear where carno=@carno
		
		fetch next from cursor_table
		into @carno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select driverno from #z_tran26 group by driverno
	open cursor_table
	fetch next from cursor_table
	into @driverno
	while(@@FETCH_STATUS <> -1)
	begin
		select @driver=''
		select @driver=namea from driver where noa=@driverno
		update #z_tran26 set driver=@driver where driverno=@driverno
		
		fetch next from cursor_table
		into @driverno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon from #z_tran26 group by carno,driverno,mon
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon
	while(@@FETCH_STATUS <> -1)
	begin
		select @day=0
		set @cmd="select @day=count(1) from (SELECT DISTINCT datea from view_trans"+@t_accy+" where carno=@carno and driverno=@driverno and LEFT(datea,6)=@mon)as a"
		execute sp_executesql @cmd,N'@carno  nvarchar(20),@driverno  nvarchar(20),@mon nvarchar(10),@day  int  output'
		,@carno=@carno,@driverno=@driverno,@mon=@mon,@day=@day  output
		
		update #z_tran26  set  [day]=@day where carno=@carno and driverno=@driverno and mon=@mon  
		fetch next from cursor_table
		into @carno,@driverno,@mon
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carkindno from #z_tran26 group by carkindno
	open cursor_table
	fetch next from cursor_table
	into @carkindno
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select * from #carkind where noa=@carkindno)
			delete #z_tran26 where carkindno=@carkindno
		fetch next from cursor_table
		into @carkindno
	end
	close cursor_table
	deallocate cursor_table
	
	if LEN(@t_carno)>0
		delete #z_tran26 where carno!=@t_carno
	delete #z_tran26 where not(driverno between @t_bdriverno and @t_edriverno)
	update #z_tran26 set gno='0' 
	-------------------------------------------------------------------	
	insert into #z_tran26
	select '1',carkindno,carKind,CHAR(255),'','','',mon,'',SUM(ISNULL(tranmoney,0)),SUM(ISNULL(miles,0)),SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0))
	,0,0,SUM(ISNULL(fixa1,0)),SUM(ISNULL(fixa2,0)),SUM(ISNULL(tire1,0)),SUM(ISNULL(tire2,0)),SUM(ISNULL(driverpay,0))
	,SUM(ISNULL(tolls,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(ticket,0)),SUM(ISNULL(carsal,0)),SUM(ISNULL(tax,0)),SUM(ISNULL(depreciation,0)),0
	from #z_tran26 where gno='0'group by carkindno,carkind,mon
	
	delete #z_tran26 where gno='0'
	update #z_tran26 set gno='0' where gno='1'
	
	insert into #z_tran26
	select '1',carkindno,carKind,CHAR(255),'','','','','',SUM(ISNULL(tranmoney,0)),SUM(ISNULL(miles,0)),SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0))
	,0,0,SUM(ISNULL(fixa1,0)),SUM(ISNULL(fixa2,0)),SUM(ISNULL(tire1,0)),SUM(ISNULL(tire2,0)),SUM(ISNULL(driverpay,0))
	,SUM(ISNULL(tolls,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(ticket,0)),SUM(ISNULL(carsal,0)),SUM(ISNULL(tax,0)),SUM(ISNULL(depreciation,0)),0
	from #z_tran26 where gno='0' group by carkindno,carkind
	
	update #z_tran26  set rate1= case when isnull(tranmoney,0)=0  then 0 else round(ISNULL(oilmoney,0)/tranmoney*100,0) end
	,rate2= case when isnull(oilmount,0)=0  then 0 else round(ISNULL(miles,0)/oilmount,3) end
	,profit=ISNULL(tranmoney,0)-ISNULL(oilmoney,0)-ISNULL(fixa1,0)-ISNULL(fixa2,0)-isnull(tire1,0)-ISNULL(tire2,0)+ISNULL(driverpay,0)
	-ISNULL(tolls,0)-ISNULL(reserve,0)-ISNULL(ticket,0)-ISNULL(carsal,0)-ISNULL(tax,0)-ISNULL(depreciation,0)
	---------------------------------------------------------------------------------------------------------------------
	select * 
	,caryear m01
	,cast(rate1 as nvarchar)+'%' m02
	,[day] m03
	,cast(rate2 as decimal(10,3)) m04
	,carno m05
	,driver m06
	,mon m07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) m08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12)) m09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) m10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa1,0)),1)),4,12)) m11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa2,0)),1)),4,12)) m12
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire1,0)),1)),4,12)) m13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire2,0)),1)),4,12)) m14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(driverpay,0)),1)),4,12))  m15
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) m16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) m17
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(reserve,0)),1)),4,12)) m18
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carsal,0)),1)),4,12)) m19
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tax,0)),1)),4,12)) m20
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(depreciation,0)),1)),4,12)) m21
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(profit,0)),1)),4,12)) m22
	from #z_tran26 order  by  carkindno,gno,mon;
--------------------------------------------------------------------------------------------------------------------*
z_trans_tb06:--z_trans_tb06 ref z_tran14
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort14  nvarchar(max)
	
	set @t_accy = '[19]'
	set @t_bdate = case when '#non'=[1] then '' else [1] end
	set @t_edate = case when '#non'=[2] then CHAR(255) else [2] end
	set @t_btrandate = case when '#non'=[3] then '' else [3] end
	set @t_etrandate = case when '#non'=[4] then CHAR(255) else [4] end
	set @t_bcustno = case when '#non'=[5] then '' else [5] end
	set @t_ecustno = case when '#non'=[6] then CHAR(255) else [6] end
	set @t_bdriverno = case when '#non'=[7] then '' else [7] end
	set @t_edriverno = case when '#non'=[8] then CHAR(255) else [8] end
	set @t_carno = case when '#non'=[9] then '' else [9] end
	set @t_po = case when '#non'=[10] then '' else [10] end
	set @t_baddr = case when '#non'=[11] then '' else [11] end
	set @t_eaddr = case when '#non'=[12] then '' else [12] end
	set @t_cno = case when '#non'=[21] then '' else [21] end
	set @t_option3  = case when '#non'=[22] then '' else [22] end
	set @t_carteam  = case when '#non'=[26] then '' else [26] end
	set @t_carkind  = case when '#non'=[14] then '' else [14] end
	set @t_calctype = case when '#non'=[13] then '' else [13] end
	set @t_field05  = case when '#non'=[25] then '' else [25] end
	set @t_sort14 = case when '#non'=[23] then '' else [23] end
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	declare @display table(
		noa nvarchar(20)
	)
	set @string = @t_field05
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	------------------------------------------------------------------------------------------------------------------
	declare  @sortkey  nvarchar(20)
	declare  @title  nvarchar(max)
	declare  @totmount1  float
	declare  @totmount2  float
	declare  @totmount3  float
	declare  @totmoney1  float
	declare  @totmoney2  float
	declare  @totmoney3  float
	declare  @totmoney4  float
	declare  @acomp  nvarchar(30)
	------------------------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran14')is not null
	BEGIN
		set @cmd = 'drop table #z_tran14'
		EXECUTE sp_executesql @cmd
	END
	create table  #z_tran14(
		gno nvarchar(3),
		sortkey nvarchar(20),
		title nvarchar(max),
		acomp nvarchar(30),
		noa nvarchar(20),	
		custno nvarchar(20),
		comp nvarchar(50),
		po nvarchar(20),
		datea nvarchar(20),
		trandate nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		straddrno nvarchar(20),
		straddr nvarchar(40),
		productno nvarchar(20),
		product nvarchar(40),
		memo nvarchar(max),
		isoutside int,
		inmount decimal(12, 3),
		pton1 decimal(12, 3),
		mount1 decimal(12, 3),
		price1 decimal(12, 3),
		money1 float,
		outmount decimal(12, 3),
		pton2 decimal(12, 3),
		mount2 decimal(12, 3),
		price2 decimal(12, 3),
		discount decimal(12, 3),
		money2 float,
		totmount1 decimal(12, 3),--客戶
		totmount2 decimal(12, 3),--司機
		totmount3 decimal(12, 3),--外車
		totmoney1 float,--客戶
		totmoney2 float,--司機
		totmoney3 float,--外車
		totmoney4 float,--差額
	)
	
	if(@t_sort14='custno')
		set @cmd = "select '0',a.custno,('客戶：'+rtrim(a.custno)+space(2)+rtrim(a.comp))"
	else
		set @cmd = "select '0',a.custno,('P／O：'+a.po)"

	set @cmd =	@cmd+
		",@t_cno,a.noa,a.custno,a.comp,a.po,a.datea,a.trandate"+
		" ,a.driverno,a.driver,a.straddrno,a.straddr,a.uccno,a.product,a.memo,isnull(e.isoutside,0)"+
		" ,a.inmount,a.pton,a.mount,a.price,a.total"+
		" ,a.outmount,a.pton2,a.mount2,(isnull(a.price2,0)+isnull(a.price3,0)),a.discount,a.total2"+
		" ,0,0,0,0,0,0,0"+
		" from  view_trans"+@t_accy+"  a"+
		" left join #carteam  b on a.carteamno=b.noa"+	
		" left join #calctype c on a.calctype=c.noa"+
		" left join carteam  d on a.carteamno=d.noa"+	
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" where "+
		" (a.datea  between  @t_bdate  and  @t_edate) and "+
		" (a.trandate between  @t_btrandate  and  @t_etrandate) and "+
		" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
		" (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
		" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
		" (len(@t_po)=0  or  a.po=@t_po) and "+
		" (len(@t_baddr)=0  or  a.straddrno=@t_baddr) and "+
		" (len(@t_eaddr)=0  or  a.endaddrno=@t_eaddr) and "+
		--" (b.noa  is  not  null) and "+
		" (c.noa  is  not  null)"
	insert into #z_tran14
	execute sp_executesql @cmd,N'@t_cno nvarchar(40),@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)
	,@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr  nvarchar(20),@t_eaddr  nvarchar(20)',
		@t_cno=@t_cno,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
		,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr
		
	if(patindex('%in%',@t_option3)=0)
	begin
		update #z_tran14 set discount=1,money2=ROUND(mount2*price2,0) where isoutside=0
	end
	if(patindex('%out%',@t_option3)=0)
	begin
		update #z_tran14 set discount=1,money2=ROUND(mount2*price2,0) where isoutside=1
	end
	
	declare cursor_table cursor for
	select sortkey from #z_tran14  group by sortkey order by sortkey
	open cursor_table
	fetch next from cursor_table
	into @sortkey
	while(@@FETCH_STATUS <> -1)
	begin
		select @title='',@acomp='',@totmount1=0,@totmount2=0,@totmount3=0,@totmoney1=0,@totmoney2=0,@totmoney3=0,@totmoney4=0
		select top 1 @title=title,@acomp=acomp from #z_tran14 where sortkey=@sortkey
		select @totmount1=SUM(mount1)
			,@totmount2=SUM(case when isoutside=0 then mount2 else 0 end) 
			,@totmount3=SUM(case when isoutside=1 then mount2 else 0 end)  
			,@totmoney1=SUM(money1)
			,@totmoney2=SUM(case when isoutside=0 then money2 else 0 end) 
			,@totmoney3=SUM(case when isoutside=1 then money2 else 0 end)
			,@totmoney4=SUM(money1-money2)
		from  #z_tran14  where  sortkey=@sortkey
		insert into #z_tran14(gno,title,acomp,sortkey,totmount1,totmount2,totmount3,totmoney1,totmoney2,totmoney3,totmoney4)
		values('1',@title,@acomp,@sortkey,@totmount1,@totmount2,@totmount3,@totmoney1,@totmoney2,@totmoney3,@totmoney4)
		fetch next from cursor_table
		into @sortkey
	end
	close cursor_table
	deallocate cursor_table
	
	if len(@t_bdate)>0
		set  @string  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @string   =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
		
	select  @string xtitlea, gno,sortkey,acomp,title,trandate tdate,driver dd,straddr addr,product pp,memo
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when mount1<0 then -1 else 1 end)*floor(abs(mount1))),1)),4,12))+RIGHT(cast(mount1 as nvarchar),4) mount1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when price1<0 then -1 else 1 end)*floor(abs(price1))),1)),4,12))+RIGHT(cast(price1 as nvarchar),4) price1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when price2<0 then -1 else 1 end)*floor(abs(price2))),1)),4,12))+RIGHT(cast(price2 as nvarchar),4) price2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when mount2<0 then -1 else 1 end)*floor(abs(mount2))),1)),4,12))+RIGHT(cast(mount2 as nvarchar),4) mount2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when totmount1<0 then -1 else 1 end)*floor(abs(totmount1))),1)),4,12))+RIGHT(cast(totmount1 as nvarchar),4) totmount1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when totmount2<0 then -1 else 1 end)*floor(abs(totmount2))),1)),4,12))+RIGHT(cast(totmount2 as nvarchar),4) totmount2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when totmount3<0 then -1 else 1 end)*floor(abs(totmount3))),1)),4,12))+RIGHT(cast(totmount3 as nvarchar),4) totmount3
		,case when discount=1 then null else discount end disc
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money1),1)),4,12)) money1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money2),1)),4,12)) money2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,totmoney1),1)),4,12)) totmoney1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,totmoney2),1)),4,12)) totmoney2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,totmoney3),1)),4,12)) totmoney3
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,totmoney4),1)),4,12)) totmoney4
	from #z_tran14 order by sortkey,gno,trandate,noa
	drop table #z_tran14;
--------------------------------------------------------------------------------------------------------------------*
z_trans_tb07:--z_trans_tb07 ref z_tran28
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort18  nvarchar(max)
	declare @t_option28 nvarchar(max)
	
	set @t_accy = '[19]'
	set @t_bdate = case when '#non'=[1] then '' else [1] end
	set @t_edate = case when '#non'=[2] then CHAR(255) else [2] end
	set @t_btrandate = case when '#non'=[3] then '' else [3] end
	set @t_etrandate = case when '#non'=[4] then CHAR(255) else [4] end
	set @t_bcustno = case when '#non'=[5] then '' else [5] end
	set @t_ecustno = case when '#non'=[6] then CHAR(255) else [6] end
	set @t_bdriverno = case when '#non'=[7] then '' else [7] end
	set @t_edriverno = case when '#non'=[8] then CHAR(255) else [8] end
	set @t_carno = case when '#non'=[9] then '' else [9] end
	set @t_po = case when '#non'=[10] then '' else [10] end
	set @t_baddr = case when '#non'=[11] then '' else [11] end
	set @t_eaddr = case when '#non'=[12] then CHAR(255) else [12] end
	set @t_cno = case when '#non'=[21] then '' else [21] end
	set @t_option3  = case when '#non'=[22] then '' else [22] end
	set @t_carteam  = case when '#non'=[26] then '' else [26] end
	set @t_carkind  = case when '#non'=[14] then '' else [14] end
	set @t_calctype = case when '#non'=[13] then '' else [13] end
	set @t_field05  = case when '#non'=[25] then '' else [25] end
	set @t_sort18 = case when '#non'=[24] then '' else [24] end
	set @t_option28 = case when '#non'=[27] then '' else [27] end
	----------------------------------------------------------------------------------------------
	set @t_option28 = case when len(@t_option28)=0 then '0' else '6' end
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	declare @display table(
		noa nvarchar(20)
	)
	set @string = @t_field05
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	------------------------------------------------------------------------------------------------------------------
	declare @tmp table(
		custno nvarchar(20),
		mon nvarchar(10),
		inmoney float,
		inmount decimal(15,3),
		outmoney1 float,
		outmount1 decimal(15,3),
		outmoney2 float,
		outmount2 decimal(15,3),
		diff float
	)
	set @cmd = 
	" select a.custno,LEFT(a.trandate,"+@t_option28+") mon"+
	"	,SUM(ISNULL(total,0)) inmoney"+
	"	,SUM(ISNULL(mount,0)) inmount"+
	"	,SUM(case when e.isoutside!=1 then (case when patindex('%in%',@t_option3)>0 then isnull(total2,0) else round(isnull(mount2,0)*isnull(price2,0),0) end) else 0 end) outmoney1"+
	"	,SUM(case when e.isoutside!=1 then isnull(mount2,0) else 0 end) outmount1"+
	"	,SUM(case when e.isoutside=1 then (case when patindex('%out%',@t_option3)>0 then isnull(total2,0) else round(isnull(mount2,0)*isnull(price3,0),0) end) else 0 end) outmoney2"+
	"	,SUM(case when e.isoutside=1 then isnull(mount2,0) else 0 end) outmount2"+
	"	 from  view_trans"+@t_accy+"  a"+
	"	 left join #carteam  b on a.carteamno=b.noa	"+
	"	 left join #calctype c on a.calctype=c.noa"+
	"	 left join carteam  d on a.carteamno=d.noa	"+
	"	 left join calctypes e on a.calctype=e.noa+e.noq"+
	"	 where (a.datea  between  @t_bdate  and  @t_edate) and "+
	"	 (a.trandate between  @t_btrandate  and  @t_etrandate) and "+
	"	 (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
	"	 (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
	"	 (len(@t_carno)=0  or  a.carno=@t_carno) and "+
	"	 (len(@t_po)=0  or  a.po=@t_po) and "+
	"	 (len(@t_baddr)=0  or  a.straddrno=@t_baddr) and "+
	"	 (len(@t_eaddr)=0  or  a.endaddrno=@t_eaddr) and "+
	--"	 (b.noa  is  not  null) and "+
	" (c.noa  is  not  null)"+
	"    and not(isnull(a.total,0)=0 and isnull(a.total2,0)=0) "+
	" group by a.custno,LEFT(a.trandate,"+@t_option28+")"
	if(@t_sort18="custno")
		set @cmd = @cmd + " order by custno,mon"
	else
		set @cmd = @cmd + " order by "+@t_sort18+",custno,mon"
	insert into @tmp(custno,mon,inmoney,inmount,outmoney1,outmount1,outmoney2,outmount2)
	execute sp_executesql @cmd,N'@t_option3 nvarchar(max),@t_cno nvarchar(40),@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)
	,@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr  nvarchar(20),@t_eaddr  nvarchar(20)'
		,@t_option3=@t_option3,@t_cno=@t_cno,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
		,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr
	update @tmp set diff = ISNULL(inmoney,0)-ISNULL(outmoney1,0)-ISNULL(outmoney2,0)
	
	if len(@t_bdate)>0
		set  @string  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @string   =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
	declare @tmp_addr1 nvarchar(20),@tmp_addr2 nvarchar(50),@tmp_addr nvarchar(max)
	select @tmp_addr1='',@tmp_addr2='',@tmp_addr=''
	select @tmp_addr1=ISNULL(addr,'') from addr where noa=@t_baddr
	select @tmp_addr2=ISNULL(addr,'') from addr2 where noa=@t_eaddr
	if(LEN(ISNULL(@tmp_addr1,''))>0 and LEN(ISNULL(@tmp_addr2,''))>0)
		if @tmp_addr1=@tmp_addr2
			set @tmp_addr = @tmp_addr1
		else
			set @tmp_addr = @tmp_addr1+'~'+@tmp_addr2
	
	select a.*,b.nick nick,@string tt1,@tmp_addr tt2
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(inmount)),1)),4,12))+'.'+RIGHT(CAST(inmount as nvarchar),3) a1
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) a2
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(outmount1)),1)),4,12))+'.'+RIGHT(CAST(outmount1 as nvarchar),3) a3
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney1),1)),4,12)) a4
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(outmount2)),1)),4,12))+'.'+RIGHT(CAST(outmount2 as nvarchar),3) a5
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney2),1)),4,12)) a6
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,diff),1)),4,12)) a7
	from(	
		select case when a.recno=1 then '1' else '2' end gno,* 
		from (select ROW_NUMBER()over(PARTITION by custno order by custno,mon) recno,* from @tmp ) a
		union all 
		select '3',0,CHAR(255),'',SUM(inmoney),SUM(inmount),SUM(outmoney1),SUM(outmount1),SUM(outmoney2),SUM(outmount2),SUM(diff)
		from @tmp) a
	left join cust b on a.custno=b.noa;
--------------------------------------------------------------------------------------------------------------------*